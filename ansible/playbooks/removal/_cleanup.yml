---
# Hard delete tenant resources
# Order matters: unmount first, then delete
# Params:
#   - tenant_dir
#   - tenant_user
#   - tenant_db
#   - backup_dir

- name: Remove PHP-FPM pool config
  ansible.builtin.file:
      path: "/etc/php/fpm/pool.d/{{ tenant_tag }}.conf"
      state: absent
  tags: [cleanup]

- name: Find all bind mounts for tenant
  ansible.builtin.shell:
      cmd: |
          mount | grep "{{ tenant_dir }}" | awk '{print $3}'
  register: tenant_mounts
  changed_when: false
  failed_when: false
  tags: [cleanup]

# also umounts from fstab
- name: Unmount tenant bind mounts
  ansible.posix.mount:
      path: "{{ mount_path }}"
      state: absent
  loop: "{{ tenant_mounts.stdout_lines | default([]) }}"
  loop_control:
      loop_var: mount_path
  when: tenant_mounts.stdout_lines | length > 0
  tags: [cleanup]

- name: Remove tenant directory
  ansible.builtin.file:
      path: "{{ tenant_dir }}"
      state: absent
  tags: [cleanup]

- name: Drop tenant database
  community.mysql.mysql_db:
      name: "{{ tenant_db }}"
      state: absent
      login_unix_socket: /var/run/mysqld/mysqld.sock
  tags: [cleanup]

- name: Remove tenant database user
  community.mysql.mysql_user:
      name: "{{ tenant_db }}"
      host: 127.0.0.1
      state: absent
      login_unix_socket: /var/run/mysqld/mysqld.sock
  tags: [cleanup]

- name: Remove tenant Linux user
  ansible.builtin.user:
      name: "{{ tenant_user }}"
      state: absent
      remove: true
  tags: [cleanup]

- name: Reload PHP-FPM service
  ansible.builtin.systemd:
      name: "php{{ php_version }}-fpm"
      state: reloaded
  tags: [cleanup]

# todo also remove hostname from nginx map

- name: Reload nginx
  ansible.builtin.systemd:
      name: "nginx"
      state: reloaded
  tags: [cleanup]
