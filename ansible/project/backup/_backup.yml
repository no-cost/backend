---
# Backup tenant-specific (non-shared) data
# Params:
#   - tenant_dir
#   - tenant_user
#   - tenant_db
#   - backup_dir
#   - additional_excludes
#   - include_readme (default false)

- name: Find bind mounts for tenant
  ansible.builtin.shell:
      cmd: mount | grep "{{ tenant_dir }}" | awk '{print $3}'
  register: _tenant_mounts
  changed_when: false
  failed_when: false
  tags: ["backup", "periodic"]

- name: Find hardlinked files in tenant public dir
  ansible.builtin.shell:
      cmd: find {{ tenant_dir }}/app/public -type f -links +1 -printf '%P\n'
  register: _hardlinked_files
  changed_when: false
  failed_when: false
  tags: ["backup", "periodic"]

- name: Backup app/public, etc/config.json, logs; exclude shared resources & additional files
  ansible.builtin.set_fact:
      _backup_rsync_excludes: "{{
          (_tenant_mounts.stdout_lines | default([])
              | map('regex_replace', '^' + tenant_dir + '/', '--exclude=/') | list) +
          (_hardlinked_files.stdout_lines | default([])
              | map('regex_replace', '^', '--exclude=/app/public/') | list) +
          (additional_excludes | default([])
              | map('regex_replace', '^', '--exclude=') | list) +
          ['--include=/app/', '--include=/app/public/', '--include=/app/public/**',
           '--include=/etc/', '--include=/etc/config.json',
           '--include=/logs/', '--include=/logs/**',
           '--exclude=*']
      }}"
  tags: ["backup", "periodic"]

- name: Create backup directory
  ansible.builtin.file:
      path: "{{ backup_dir }}"
      state: directory
      mode: "0700"
  tags: ["backup", "periodic"]

- name: Backup tenant directory
  ansible.posix.synchronize:
      src: "{{ tenant_dir }}/"
      dest: "{{ backup_dir }}/files/"
      recursive: true
      links: true
      rsync_opts: "{{ _backup_rsync_excludes }}"
  delegate_to: localhost
  tags: ["backup", "periodic"]

- name: Dump tenant database
  community.mysql.mysql_db:
      name: "{{ tenant_db }}"
      state: dump
      target: "{{ backup_dir }}/database.sql"
      login_unix_socket: /var/run/mysqld/mysqld.sock
  tags: ["backup", "periodic"]

- name: Render export README into backup
  ansible.builtin.template:
      src: "{{ playbook_dir }}/files/README_EXPORT.md"
      dest: "{{ backup_dir }}/README.md"
      mode: "0644"
  when: include_readme | default(false) | bool
  tags: ["backup", "periodic"]

- name: Compress backup
  community.general.archive:
      path: "{{ backup_dir }}"
      dest: "{{ backup_dir }}.tar.gz"
      format: gz
  tags: ["backup", "periodic"]

- name: Remove uncompressed backup directory
  ansible.builtin.file:
      path: "{{ backup_dir }}"
      state: absent
  tags: ["backup", "periodic"]
