---
# root in /app/public/

- name: Copy skeleton structure and mount WordPress core directories
  ansible.builtin.include_tasks: ../helpers/copy_structure.yml
  vars:
      mount_paths:
          - "app/public/wp-admin"
          - "app/public/wp-content/plugins"
          - "app/public/wp-content/themes"
          - "app/public/wp-content/mu-plugins"
          - "app/public/wp-includes"
      exclude_paths:
          - "app/public/license.txt"
      service_type: "wordpress"
  tags: [always]

- name: Run WordPress installation
  ansible.builtin.command:
      cmd: |
          wp core install
          --url='https://{{ tenant_hostname }}'
          --title='{{ tenant_tag | replace("_", " ") | title }}'
          --admin_user='admin'
          --admin_password='{{ lookup('password', '/dev/null chars=hexdigits length=32') }}'
          --admin_email='{{ tenant_admin_email }}'
          --skip-email
      chdir: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/public"
  become: true
  become_user: "tenant_{{ tenant_tag }}"
  changed_when: true
  tags: [always]

- name: Set WordPress permalink structure
  ansible.builtin.command:
      cmd: "wp rewrite structure '/%postname%/' --hard"
      chdir: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/public"
  become: true
  become_user: "tenant_{{ tenant_tag }}"
  changed_when: true
  tags: [always]

- name: Generate password reset key for admin
  ansible.builtin.command:
      cmd: wp user reset-password admin --skip-email --porcelain
      chdir: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/public"
  become: true
  become_user: "tenant_{{ tenant_tag }}"
  register: _wp_reset_result
  changed_when: true
  tags: [always]

- name: Send welcome email
  community.general.mail:
      host: "127.0.0.1"
      to: "{{ tenant_admin_email }}"
      subject: "Welcome to no-cost.site!"
      body: |
          Your WordPress site has been provisioned successfully!

          Domain: https://{{ tenant_hostname }}

          To set your admin password, visit the following link:
          https://{{ tenant_hostname }}/wp-login.php?action=rp&key={{ _wp_reset_result.stdout | trim | urlencode }}&login=admin

          If you have any questions, please let us know by replying to this e-mail.
      from: "noreply@{{ main_domain }}"
  failed_when: false
  tags: [always]
