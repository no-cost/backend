---
# root in /app/

- name: Copy skeleton structure and mount vendor
  ansible.builtin.include_tasks: ../helpers/copy_structure.yml
  vars:
      mount_paths:
          - "app/vendor"
      exclude_paths:
          - "app/LICENSE"
          - "app/README.md"
          - "app/composer.json"
          - "app/composer.lock"
          - "app/public/.htaccess"
          - "app/public/web.config"
          # hardlinked as config.php after install
          - "app/config.common.php"
      hardlink_paths:
          - "app/extend.php"
          - "app/flarum"
          - "app/site.php"
          - "app/public/index.php"
      service_type: "flarum"
  tags: [always]

- name: Render tenant config
  ansible.builtin.include_tasks: ../helpers/render_config.yml
  tags: [always]

# just so that the initial table migrations can run
- name: Render install.json template
  ansible.builtin.template:
      src: "{{ playbook_dir }}/files/srv/skeleton/flarum/install.json"
      dest: "/tmp/tenant_{{ tenant_tag }}_install.json"
      owner: "tenant_{{ tenant_tag }}"
      group: "tenant_{{ tenant_tag }}"
      mode: "640"
  tags: [always]

- name: Run install command
  ansible.builtin.command:
      cmd: |
          php flarum install --file="/tmp/tenant_{{ tenant_tag }}_install.json" --config="/dev/null"
      chdir: "{{ paths.tenants.root }}/{{ tenant_tag }}/app"
  become: true
  become_user: "tenant_{{ tenant_tag }}"
  tags: [always]

- name: Cleanup install.json template
  ansible.builtin.file:
      path: "/tmp/tenant_{{ tenant_tag }}_install.json"
      state: absent
  tags: [always]

# config.php can't exist before install, because Flarum disables the install command when that file is present:
# https://github.com/no-cost/flarum-multitenant/blob/2bd2da87c539cb187040ff84c7b06988dc6e17e3/vendor/flarum/core/src/Foundation/Site.php#L27-L34
- name: Hardlink config.common.php as config.php from skeleton
  ansible.builtin.file:
      src: "{{ paths.tenants.skeleton_root }}/flarum/app/config.common.php"
      dest: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/config.php"
      state: hard
      force: true
  tags: [always]

- name: Remove storage/logs directory created by installer
  ansible.builtin.file:
      path: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/storage/logs"
      state: absent
  tags: [always]

- name: Symlink storage/logs to tenant logs directory
  ansible.builtin.file:
      src: "../../logs/"
      dest: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/storage/logs"
      state: link
      owner: "tenant_{{ tenant_tag }}"
      group: "tenant_{{ tenant_tag }}"
  tags: [always]

- name: Generate password reset token for admin
  ansible.builtin.set_fact:
      _flarum_reset_token: "{{ lookup('password', '/dev/null chars=ascii_lowercase,digits length=40') }}"
  tags: [always]

- name: Insert password reset token into database
  community.mysql.mysql_query:
      login_unix_socket: /var/run/mysqld/mysqld.sock
      login_db: "tenant_{{ tenant_tag }}"
      query: |
          INSERT INTO password_tokens (token, user_id, created_at)
          VALUES (%s, 1, NOW())
      positional_args:
          - "{{ _flarum_reset_token }}"
  tags: [always]

- name: Send welcome email
  community.general.mail:
      host: "127.0.0.1"
      to: "{{ tenant_admin_email }}"
      subject: "Welcome! â€” no-cost.site"
      body: |
          Your Flarum forum has been provisioned successfully!

          Domain: https://{{ tenant_hostname }}

          To set your admin password for your instance, visit the following link:
          https://{{ tenant_hostname }}/reset/{{ _flarum_reset_token }}

          To set your password for the settings panel, visit the following link:
          https://{{ main_domain }}/reset-password?token={{ tenant_reset_token }}

          If you have any questions, please let us know by replying to this e-mail.
      from: "noreply@{{ main_domain }}"
  failed_when: false
  tags: [never, "send-email"]
