---
# root in /app/public/

# TODO: hardlink files, check if `resources/` can be mounted read-only
- name: Copy skeleton structure and mount MediaWiki core directories
  ansible.builtin.include_tasks: ../helpers/copy_structure.yml
  vars:
      mount_paths:
          - "app/public/extensions"
          - "app/public/includes"
          - "app/public/languages"
          - "app/public/skins"
          - "app/public/sql"
          - "app/public/vendor"
      exclude_paths:
          - "app/public/CODE_OF_CONDUCT.md"
          - "app/public/COPYING.md"
          - "app/public/CREDITS.md"
          - "app/public/README.md"
          - "app/public/UPGRADE"
          - "app/public/bundlesize.config.js"
          - "app/public/composer.json"
          - "app/public/composer.local.json"
          - "app/public/composer.lock"
      service_type: "mediawiki"
  tags: [always]

- name: Render tenant config
  ansible.builtin.include_tasks: ../helpers/render_config.yml
  tags: [always]

- name: Run MediaWiki installation script
  ansible.builtin.shell:
      cmd: |
          php maintenance/run.php install \
          --dbname="tenant_{{ tenant_tag }}" \
          --dbserver="127.0.0.1" \
          --dbuser="tenant_{{ tenant_tag }}" \
          --dbpass={{ _tenant_db_password | quote }} \
          --server={{ ('https://' + tenant_tag + '.' + main_domain) | quote }} \
          --scriptpath="" \
          --lang="en" \
          --pass={{ lookup('password', '/dev/null chars=hexdigits length=32') | quote }} {{ (tenant_tag | replace("_", " ") | title) | quote }} \
          "Admin"
      chdir: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/public"
  become: true
  become_user: "tenant_{{ tenant_tag }}"
  changed_when: true
  tags: [always]

- name: Run MediaWiki update script
  ansible.builtin.shell:
      cmd: "php maintenance/run.php update --quick"
      chdir: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/public"
  become: true
  become_user: "tenant_{{ tenant_tag }}"
  changed_when: true
  tags: [always]

- name: Overwrite LocalSettings.php
  ansible.builtin.command:
      cmd: mv --force LocalSettings_temp.php LocalSettings.php
      chdir: "{{ paths.tenants.root }}/{{ tenant_tag }}/app/public"
  tags: [always]

- name: Generate temporary password for admin
  ansible.builtin.set_fact:
      _mw_temp_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=16') }}"
  tags: [always]

- name: Set temporary password in database
  community.mysql.mysql_query:
      login_unix_socket: /var/run/mysqld/mysqld.sock
      login_db: "tenant_{{ tenant_tag }}"
      query: |
          UPDATE user
          SET user_newpassword = CONCAT(':B:1234:', MD5(CONCAT('1234-', MD5(%s)))),
              user_newpass_time = DATE_FORMAT(NOW(), '%%Y%%m%%d%%H%%i%%s')
          WHERE user_name = 'Admin'
      positional_args:
          - "{{ _mw_temp_password }}"
  tags: [always]

- name: Send welcome email
  community.general.mail:
      host: "127.0.0.1"
      to: "{{ tenant_admin_email }}"
      subject: "Welcome to no-cost.site!"
      body: |
          Your MediaWiki site has been provisioned successfully!

          Domain: https://{{ tenant_hostname }}

          To log in to your instance, visit the following link:
          https://{{ tenant_hostname }}/index.php?title=Special:UserLogin

          Username: Admin
          Temporary password: {{ _mw_temp_password }}

          You will be prompted to set a new password after logging in.

          To set your password for the settings panel, visit the following link:
          https://{{ main_domain }}/reset-password?token={{ tenant_reset_token }}

          If you have any questions, please let us know by replying to this e-mail.
      from: "noreply@{{ main_domain }}"
  failed_when: false
  tags: [always]
