---
#   - tenant_tag
#   - service_type: flarum|mediawiki|wordpress
#   - skip_backup: boolean (default false)
#   - delete_older_than_days: int (default 7, negative to disable)
#   - send_email: boolean (default false) — notify admin about removal
#   - tenant_admin_email: string (required when send_email is true)
#   - tenant_hostname: string (required when send_email is true)
#   - removal_reason: string (optional, included in removal email)
#   - backup_dir_override: string (optional, overrides default backup dir)

- name: Backup (and optionally remove) tenant
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  tasks:
      - name: Set tenant paths
        ansible.builtin.set_fact:
            tenant_dir: "{{ paths.tenants.root }}/{{ tenant_tag }}"
            tenant_user: "tenant_{{ tenant_tag }}"
            tenant_db: "tenant_{{ tenant_tag }}"
            backup_dir: "{{ backup_dir_override | default(paths.backup_attic_root + '/' + tenant_tag) }}"
        tags: [always]

      - name: Override backup dir for periodic backups
        ansible.builtin.set_fact:
            backup_dir: "{{ paths.backup_host_root }}/{{ tenant_tag }}/{{ lookup('pipe', 'date +%Y-%m-%d') }}"
        when: backup_dir_override is not defined
        tags: [never, "periodic"]

      - name: Verify tenant exists
        ansible.builtin.stat:
            path: "{{ tenant_dir }}"
        register: tenant_exists
        tags: [always]

      - name: Fail if tenant does not exist
        ansible.builtin.fail:
            msg: "Tenant directory `{{ tenant_dir }}` does not exist!"
        when: not tenant_exists.stat.exists
        tags: [always]

      # optional backup
      - name: Backup tenant data
        ansible.builtin.include_tasks: ./backup/_backup.yml
        when: not (skip_backup | default(false) | bool)
        tags: ["backup", "periodic"]

      # prune old
      - name: Delete old periodic backups
        ansible.builtin.include_tasks: ./backup/_prune.yml
        when: (delete_older_than_days | default(7) | int) >= 0
        tags: [never, "periodic"]

      # hard delete
      - name: Cleanup tenant resources
        ansible.builtin.include_tasks: ./backup/_cleanup.yml
        tags: ["cleanup"]

      - name: Send removal notification email
        community.general.mail:
            host: "127.0.0.1"
            to: "{{ tenant_admin_email }}"
            subject: "Your site has been removed — no-cost.site"
            body: |
                Your site at https://{{ tenant_hostname }} has been removed.
                {% if removal_reason | default('') | length > 0 %}

                Reason: {{ removal_reason }}
                {% endif %}

                If you believe this was a mistake, please contact us by replying to this e-mail.
                There is a chance that we have backed up your site and can restore it for you.
            from: "noreply@{{ main_domain }}"
        failed_when: false
        when: send_email | default(false) | bool
        tags: ["cleanup"]
